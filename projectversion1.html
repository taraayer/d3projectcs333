<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS 333: Assignment 3</title>

    <!-- D3 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <h1 style="margin: 40px 0px 10px 50px">CS 333: Assignment 3</h1>
    <p style="margin: 10px 0px 20px 50px; font-size: 26px"> Select song variables of your choosing from the dropdown, and filter by genres (dropdown) and track popularity (sliders). A parallel plot and scatterplot matrix will be displayed!</p>

    <div id="container"></div>
    
    <!-- Dropdown menu for variable selection -->
    <br><br><br>

    <div id="variableSelection" class="dropdown" style="position:absolute; right: 50px">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
            Variable Selection
        </button>
        
            <div class="dropdown-menu">
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "energy"> Energy
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "tempo"> Tempo
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "danceability"> Danceability
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "loudness"> Loudness
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "valence"> Cheeriness
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "speechiness"> Speechiness
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "duration_ms"> Duration
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "track_popularity"> Track Popularity
                </label>
            </div>

    </div>

    <br><br>

    <!-- Dropdown menu for genre selection -->
    <div id = "genreSelection" class="dropdown" style="position:absolute; right: 50px">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
            Genre Selection
        </button>
            <div class="dropdown-menu" style="max-height:200px; overflow-y: auto;">
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="pop"> Pop</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="rock"> Rock</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="jazz"> Jazz</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="classical"> Classical</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="hip-hop"> Hip-Hop</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="afrobeats"> Afrobeats</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="latin"> Latin</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="indian"> Indian</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="country"> Country</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="r&b"> R&B</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="electronic"> Electronic</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="soul"> Soul</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="gaming"> Gaming</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="j-pop"> J-Pop</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="metal"> Metal</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="reggae"> Reggae</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="k-pop"> K-Pop</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="arabic"> Arabic</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="punk"> Punk</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="blues"> Blues</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="folk"> Folk</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="lofi"> LoFi</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="brazilian"> Brazilian</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="ambient"> Ambient</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="korean"> Korean</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="world"> World</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="indie"> Indie</label>
            </div>
    </div>

    <!-- Slider for popularity -->
    <br><br>
    <label style="position:absolute; right: 50px" for="pop_max_slider">Max Popularity: <span id="maxSliderValue">100</span></label>
    <br>
    <input style="position:absolute; right: 50px" type="range" id="pop_max_slider" min="68" max="100" value="100">
   
    <br>
    <label style="position:absolute; right: 50px" for="pop_min_slider">MinPopularity: <span id="minSliderValue">68</span></label>
    <br>
    <input style="position:absolute; right: 50px" type="range" id="pop_min_slider" min="68" max="100" value="68">

    <br>
    <!-- Color legend -->
    <div id="genre-legend" style="position:absolute; right: 50px; top: 450px;"></div>

    <!-- Create a div where the graph will take place -->
    <br>
    <div id="plots-container" style="display:flex; flex-wrap: wrap; gap: 20px; margin: 50px;">
        <div id="parallel" style="flex: 1 1 500px; min-width: 300px; height: 600px;"></div>
        <div id="scatter" style="flex: 1 1 500px; min-width: 300px; height: 600px;"></div>
    </div>



    <script>

        function getPlotSize(containerId) {
            const container = document.getElementById(containerId);
            const rect = container.getBoundingClientRect();
            return {
                width: rect.width - 40,
                height: rect.height - 20
            };
        }



        function drawParallelPlot(data, selVar, width, height, genreColors) {
            // if (selVar.length === 0 || data.length === 0) return;

            d3.select("#parallel").html(""); // clear old plot

            const margin = { top: 30, right: 50, bottom: 10, left: 50 };
            const svg = d3.select("#parallel")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const fixedDomains = {
                energy: [0, 1],
                tempo: [40, 260],           // adjust to your dataset max tempo
                danceability: [0, 1],
                loudness: [-60, 5],        // typical loudness range in dB
                valence: [0, 1],
                speechiness: [0, 1],
                duration_ms: [60000, 550000],  // e.g., up to 10 minutes
                track_popularity: [60, 100]
            };

            // Y scale
            let y = {};
            selVar.forEach(dim => {
                y[dim] = d3.scaleLinear()
                    .domain(fixedDomains[dim])  // use fixed domain
                    .range([height, 0]);

            });

            // X scale 
            let x = d3.scalePoint()
                .domain(selVar)
                .range([0, width])
                .padding(1);

            // Line generator
            function path(d) {
                return d3.line()(selVar.map(p => [x(p), y[p](d[p])]));
            }

            // Draw foreground lines
            svg.append("g")
                .attr("class", "foreground")
                .selectAll("path")
                .data(data)
                .join("path")
                .attr("d", path)
                .attr("stroke", d => genreColors(d.playlist_genre))
                .attr("fill", "none")
                .attr("stroke-width", 1)
                .attr("stroke-opacity", 0.4);

            // Axis and title for each dimension
            const g = svg.selectAll(".dimension")
                .data(selVar)
                .join("g")
                .attr("class", "dimension")
                .attr("transform", d => `translate(${x(d)})`);

            g.append("g")
                .each(function(d){ d3.select(this).call(d3.axisLeft(y[d])); })
                .append("text")
                .style("text-anchor", "middle")
                .attr("y", -10)
                .text(d => d)
                .style("fill", "black")
                .style("font-size", "12px");

            // Add brushing on each axis
            g.append("g")
                .attr("class", "brush")
                .each(function(d){
                    d3.select(this)
                        .call(
                            d3.brushY()
                                .extent([[-8, 0], [8, height]])
                                .on("brush", brushed)
                                .on("end", brushed)
                        );
                });

            // Brushing highlight logic
            function brushed(event) {
                const actives = [];

                svg.selectAll(".brush")
                    .each(function(d) {
                        const brush = d3.brushSelection(this);
                        if (brush) {
                            actives.push({
                                dim: d,
                                extent: brush.map(y[d].invert)
                            });
                        }
                    });

                svg.selectAll(".foreground path")
                    .attr("stroke-opacity", function(d) {
                        return actives.every(active => {
                            return d[active.dim] >= Math.min(...active.extent) &&
                                d[active.dim] <= Math.max(...active.extent);
                        }) ? 0.9 : 0.05;
                    });
            }
        }

        function drawScatterplotMatrix(data, selVar, genreColors) {
            // Clear existing scatterplot
            d3.select("#scatter").html("");

            // if (selVar.length === 0 || data.length === 0) return;

            const container = document.getElementById("scatter");
            const rect = container.getBoundingClientRect();
            const width = rect.width - 20;   // small padding
            const height = rect.height || width; // make it square if height not set

            const n = selVar.length;
            const margin = { top: 30, right: 30, bottom: 30, left: 30 };
            const cellSize = Math.min((width - margin.left - margin.right) / n, 
                                    (height - margin.top - margin.bottom) / n);
            const padding = Math.max(5, cellSize * 0.05);

            const svg = d3.select("#scatter")
                .append("svg")
                .attr("width", margin.left + margin.right + n * cellSize)
                .attr("height", margin.top + margin.bottom + n * cellSize)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const allRanges = {
                energy: [0, 1],
                tempo: [40, 260],
                danceability: [0, 1],
                loudness: [-60, 5],
                valence: [0, 1],
                speechiness: [0, 1],
                duration_ms: [60000, 550000],
                track_popularity: [60, 100]
            };

            // Create scales for each variable
            const xScales = {};
            const yScales = {};
            selVar.forEach(v => {
                xScales[v] = d3.scaleLinear()
                            .domain(allRanges[v])
                            .range([padding, cellSize - padding]);

                yScales[v] = d3.scaleLinear()
                            .domain(allRanges[v])
                            .range([cellSize - padding, padding]);
            });

            // Build cells
            const cells = svg.selectAll(".cell")
                .data(selVar.flatMap(x => selVar.map(y => ({ x, y }))))
                .join("g")
                .attr("class", "cell")
                .attr("transform", d => `translate(${selVar.indexOf(d.x) * cellSize}, ${selVar.indexOf(d.y) * cellSize})`);

            // Cell background
            cells.append("rect")
                .attr("x", padding)
                .attr("y", padding)
                .attr("width", cellSize-2*padding)
                .attr("height", cellSize-2*padding)
                .attr("fill", "white")
                .attr("stroke", "#ccc");

            // Scatter points
            cells.each(function(d) {
                d3.select(this).selectAll("circle")
                    .data(data)
                    .join("circle")
                    .attr("cx", v => xScales[d.x](v[d.x]))
                    .attr("cy", v => yScales[d.y](v[d.y]))
                    .attr("r", Math.max(2, cellSize * 0.01))
                    .attr("fill", v => genreColors(v.playlist_genre))
                    .attr("fill-opacity", 0.6);
            });

            // Axis and labels
            const axisTicks = Math.max(2, Math.floor(cellSize / 50));
            svg.selectAll(".x-axis")
                .data(selVar)
                .join("g")
                .attr("class", "x-axis")
                .attr("transform", (d, i) => `translate(${i * cellSize}, ${(n * cellSize) - padding})`)
                .call(d => d.each(function(v) {
                    const xScale = d3.scaleLinear().domain(allRanges[v]).range([padding, cellSize - padding]);
                    d3.select(this).call(d3.axisBottom(xScale).ticks(axisTicks));
                }));

            svg.selectAll(".y-axis")
                .data(selVar)
                .join("g")
                .attr("class", "y-axis")
                .attr("transform", (d, i) => `translate(${padding}, ${i * cellSize})`)
                .call(d => d.each(function(v) {
                    const yScale = d3.scaleLinear().domain(allRanges[v]).range([cellSize - padding, padding]);
                    d3.select(this).call(d3.axisLeft(yScale).ticks(axisTicks));
                }));

            svg.selectAll(".x-label")
                .data(selVar)
                .join("text")
                .attr("class", "x-label")
                .attr("x", (d, i) => i * cellSize + cellSize / 2)
                .attr("y", n * cellSize + 25)
                .attr("text-anchor", "middle")
                .attr("font-weight", "bold")
                .style("font-size", 12)
                .text(d => d);

            svg.selectAll(".y-label")
                .data(selVar)
                .join("text")
                .attr("class", "y-label")
                .attr("text-anchor", "middle")
                .attr("dominant-baseline", "middle")
                .attr("x", -margin.left + 15)
                .attr("y", (d, i) => i * cellSize + cellSize / 2)
                .attr("transform", (d, i) => `rotate(-90, ${-margin.left + 10}, ${i * cellSize + cellSize / 2})`)
                .style("font-weight", "bold")
                .style("font-size", 12)
                .text(d => d);

            // // Axis for leftmost column and bottom row
            // selVar.forEach((v, i) => {
            //     // X axis on bottom row
            //     const xAxis = d3.axisBottom(xScales[v]).ticks(3);
            //     svg.append("g")
            //         .attr("transform", `translate(${i * cellSize}, ${(n - 1) * cellSize})`)
            //         .call(xAxis);

            //     // Y axis on leftmost column
            //     const yAxis = d3.axisLeft(yScales[v]).ticks(3);
            //     svg.append("g")
            //         .attr("transform", `translate(0, ${i * cellSize})`)
            //         .call(yAxis);
            // });

            // // Labels on top row and left column
            // selVar.forEach((v, i) => {
            //     // Top labels
            //     svg.append("text")
            //         .attr("x", i * cellSize + cellSize / 2)
            //         .attr("y", -10)
            //         .attr("text-anchor", "middle")
            //         .attr("font-weight", "bold")
            //         .text(v);

            //     // Left labels
            //     svg.append("text")
            //         .attr("x", -10)
            //         .attr("y", i * cellSize + cellSize / 2)
            //         .attr("text-anchor", "end")
            //         .attr("dominant-baseline", "middle")
            //         .attr("font-weight", "bold")
            //         .text(v);
            // });
        }


    </script>

    <script>
        function getSelectedDropDown(dropdownMenu, type) {
            let selected = [];
            if (type === "variables") {
                selected = dropdownMenu.querySelectorAll(".var-check:checked");
            } else if (type === "genre") {
                selected = dropdownMenu.querySelectorAll(".gen-check:checked");
            }
            return Array.from(selected).map(d => d.value);
        }

        d3.csv("spotifydata.csv").then(function(data) {
            data.forEach(d => {
                d.energy = +d.energy;
                d.tempo = +d.tempo;
                d.danceability = +d.danceability;
                d.loudness = +d.loudness;
                d.valence = +d.valence;
                d.speechiness = +d.speechiness;
                d.track_popularity = +d.track_popularity;
                d.duration_ms = +d.duration_ms;
            });

            const maxSlider = document.getElementById("pop_max_slider");
            const maxSliderValue = document.getElementById("maxSliderValue");
            const minSlider = document.getElementById("pop_min_slider");
            const minSliderValue = document.getElementById("minSliderValue");

            const variableSelection = document.getElementById("variableSelection");
            const genreSelection = document.getElementById("genreSelection");

            let currMaxPop = Number(maxSlider.value);
            let currMinPop = Number(minSlider.value);
            let selVar = [];
            let selGen = [];

            const allGenres = [
            "pop","rock","jazz","classical","hip-hop","afrobeats","latin","indian",
            "country","r&b","electronic","soul","gaming","j-pop","metal","reggae",
            "k-pop","arabic","punk","blues","folk","lofi","brazilian","ambient",
            "korean","world","indie"
            ];

            // Your RGB palette (pick first 27 for 27 genres)
            const rgbPalette = [
            [173, 216, 230], // light blue
            [255, 69, 0],    // orange-red
            [138, 43, 226],  // blue-violet
            [255, 204, 0],   // yellow
            [0, 191, 255],   // deep sky blue
            [144, 238, 144], // light green
            [30, 144, 255],  // dodger blue
            [255, 20, 147],  // deep pink
            [0, 0, 255],     // blue
            [124, 252, 0],   // lawn green
            [0, 0, 139],     // dark blue
            [218, 112, 214], // orchid
            [72, 61, 139],   // dark slate blue
            [240, 128, 128], // light coral
            [123, 104, 238], // medium slate blue
            [154, 205, 50],  // yellow-green
            [128, 0, 128],   // purple
            [255, 165, 0],   // orange
            [176, 48, 96],   // maroon
            [143, 188, 143], // dark sea green
            [220, 20, 60],   // crimson
            [128, 128, 0],   // olive
            [34, 139, 34],   // forest green
            [255, 0, 255],   // magenta
            [0, 255, 127],   // spring green
            [0, 255, 255],   // cyan
            [139, 69, 19]    // saddle brown
            ];

            // Convert to CSS rgb() strings
            const colorStrings = rgbPalette.map(d => `rgb(${d[0]}, ${d[1]}, ${d[2]})`);

            // Create D3 ordinal scale
            const genreColors = d3.scaleOrdinal()
            .domain(allGenres)
            .range(colorStrings);



            const legendDiv = d3.select("#genre-legend");

            function update(data) {
                const parallelSize = getPlotSize("parallel");

                const scatterSize = getPlotSize("scatter");

                // Filter data
                temp = data
                    .filter(d => d.track_popularity >= currMinPop && d.track_popularity <= currMaxPop)
                    .filter(d => selGen.includes(d.playlist_genre))
                    .map(d => {
                        const obj = { playlist_genre: d.playlist_genre, track_popularity: d.track_popularity };
                        selVar.forEach(col => obj[col] = d[col]);
                        return obj;
                    });

                // Update legend
                legendDiv.html("");
                selGen.forEach(g => {
                    const item = legendDiv.append("div")
                        .style("display", "flex")
                        .style("align-items", "center")
                        .style("margin-bottom", "3px");
                    item.append("div")
                        .style("width", "15px")
                        .style("height", "15px")
                        .style("background-color", genreColors(g))
                        .style("margin-right", "5px");
                    item.append("span").text(g);
                });
                drawParallelPlot(temp, selVar, parallelSize.width, parallelSize.height, genreColors);
                drawScatterplotMatrix(temp, selVar, genreColors, scatterSize.width, scatterSize.height);                                

            }

            update(data);

            // Slider events
            maxSlider.addEventListener("input", () => {
                let newMax = Number(maxSlider.value);
                if (newMax < currMinPop) {
                    newMax = currMinPop;
                    maxSlider.value = newMax;
                }
                currMaxPop = newMax;
                maxSliderValue.textContent = currMaxPop;
                update(data);
            });

            minSlider.addEventListener("input", () => {
                let newMin = Number(minSlider.value);
                if (newMin > currMaxPop) {
                    newMin = currMaxPop;
                    minSlider.value = newMin;
                }
                currMinPop = newMin;
                minSliderValue.textContent = currMinPop;
                update(data);
            });

            // Dropdown events
            document.querySelectorAll(".var-check").forEach(cb => {
                cb.addEventListener("change", () => {
                    selVar = getSelectedDropDown(variableSelection, "variables");
                    update(data);
                });
            });

            document.querySelectorAll(".gen-check").forEach(cb => {
                cb.addEventListener("change", () => {
                    selGen = getSelectedDropDown(genreSelection, "genre");
                    update(data);
                });
            });

            window.addEventListener("resize", update);
        });
    </script>

    <!-- Load JS in correct order -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>
</html>
