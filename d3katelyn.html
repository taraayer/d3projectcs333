<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS 333: Assignment 3</title>

    <!-- D3 -->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- Bootstrap 4 CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>
<body>
    <h1 style="margin: 40px 0px 10px 50px">CS 333: Assignment 3</h1>


    <div id="container"></div>
    
    <!-- Dropdown menu for variable selection -->
    <br><br><br>

    <div id="variableSelection" class="dropdown" style="position:absolute; right: 50px">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
            Variable Selection
        </button>
        
            <div class="dropdown-menu">
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "energy"> Energy
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "tempo"> Tempo
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "danceability"> Danceability
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "loudness"> Loudness
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "valence"> Cheeriness
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "speechiness"> Speechiness
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "duration_ms"> Duration
                </label>
                <label class="dropdown-item">
                    <input type="checkbox" class="var-check" value = "track_popularity"> Track Popularity
                </label>
            </div>

    </div>

    <br><br>

    <!-- Dropdown menu for genre selection -->
    <div id = "genreSelection" class="dropdown" style="position:absolute; right: 50px">
        <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown">
            Genre Selection
        </button>
            <div class="dropdown-menu" style="max-height:200px; overflow-y: auto;">
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="pop"> Pop</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="rock"> Rock</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="jazz"> Jazz</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="classical"> Classical</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="hip-hop"> Hip-Hop</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="afrobeats"> Afrobeats</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="latin"> Latin</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="indian"> Indian</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="country"> Country</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="r&b"> R&B</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="electronic"> Electronic</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="soul"> Soul</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="gaming"> Gaming</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="j-pop"> J-Pop</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="metal"> Metal</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="reggae"> Reggae</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="k-pop"> K-Pop</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="arabic"> Arabic</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="punk"> Punk</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="blues"> Blues</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="folk"> Folk</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="lofi"> LoFi</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="brazilian"> Brazilian</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="ambient"> Ambient</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="korean"> Korean</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="world"> World</label>
                <label class="dropdown-item"><input type="checkbox" class="gen-check" value="indie"> Indie</label>
            </div>
    </div>

    <!-- Slider for popularity -->
    <br><br>
    <label style="position:absolute; right: 50px" for="pop_max_slider">Max Popularity: <span id="maxSliderValue">100</span></label>
    <br>
    <input style="position:absolute; right: 50px" type="range" id="pop_max_slider" min="68" max="100" value="100">
   
    <br>
    <label style="position:absolute; right: 50px" for="pop_min_slider">Min Popularity: <span id="minSliderValue">68</span></label>
    <br>
    <input style="position:absolute; right: 50px" type="range" id="pop_min_slider" min="68" max="100" value="68">

    <!-- Create a div where the graph will take place -->
    <br>
    <div id="parallel" style="height: 600px;"></div>


    <script>
        function getPlotSize() {
            const container = document.getElementById("parallel");
            const rect = container.getBoundingClientRect();

            // Space taken by title + dropdowns + sliders
            const reservedTopSpace = 100; // adjust if needed

            // Compute available height
            const height = Math.max(200, rect.height - reservedTopSpace);
            // const height = Math.max(200, window.innerHeight - reservedTopSpace);

            return {
                width: rect.width - 40,
                height: height
            };
        }


        function drawParallelPlot(data, selVar, width, height) {

            d3.select("#parallel").html(""); // clear old plot

            const margin = { top: 30, right: 50, bottom: 10, left: 50 };
            const svg = d3.select("#parallel")
                .append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const fixedDomains = {
                energy: [0, 1],
                tempo: [0, 260],           // adjust to your dataset max tempo
                danceability: [0, 1],
                loudness: [-60, 5],        // typical loudness range in dB
                valence: [0, 1],
                speechiness: [0, 1],
                duration_ms: [0, 550000],  // e.g., up to 10 minutes
                track_popularity: [0, 100]
            };

            // Y scale
            let y = {};
            selVar.forEach(dim => {
                y[dim] = d3.scaleLinear()
                    .domain(fixedDomains[dim])  // use fixed domain
                    .range([height, 0]);

            });

            // X scale 
            let x = d3.scalePoint()
                .domain(selVar)
                .range([0, width])
                .padding(1);

            // Line generator
            function path(d) {
                return d3.line()(selVar.map(p => [x(p), y[p](d[p])]));
            }

            // Draw foreground lines
            svg.append("g")
                .attr("class", "foreground")
                .selectAll("path")
                .data(data)
                .join("path")
                .attr("d", path)
                .attr("stroke", "steelblue")
                .attr("fill", "none")
                .attr("stroke-width", 1)
                .attr("stroke-opacity", 0.4);

            // Axis and title for each dimension
            const g = svg.selectAll(".dimension")
                .data(selVar)
                .join("g")
                .attr("class", "dimension")
                .attr("transform", d => `translate(${x(d)})`);

            g.append("g")
                .each(function(d){ d3.select(this).call(d3.axisLeft(y[d])); })
                .append("text")
                .style("text-anchor", "middle")
                .attr("y", -10)
                .text(d => d)
                .style("fill", "black")
                .style("font-size", "12px");

            // Add brushing on each axis
            g.append("g")
                .attr("class", "brush")
                .each(function(d){
                    d3.select(this)
                        .call(
                            d3.brushY()
                                .extent([[-8, 0], [8, height]])
                                .on("brush", brushed)
                                .on("end", brushed)
                        );
                });

            // Brushing highlight logic
            function brushed(event) {
                const actives = [];

                svg.selectAll(".brush")
                    .each(function(d) {
                        const brush = d3.brushSelection(this);
                        if (brush) {
                            actives.push({
                                dim: d,
                                extent: brush.map(y[d].invert)
                            });
                        }
                    });

                svg.selectAll(".foreground path")
                    .attr("stroke-opacity", function(d) {
                        return actives.every(active => {
                            return d[active.dim] >= Math.min(...active.extent) &&
                                d[active.dim] <= Math.max(...active.extent);
                        }) ? 0.9 : 0.05;
                    });
            }
        }

        // Helper function: get selected checkboxes from dropdown
        function getSelectedDropDown(dropdownMenu, type) {
            let selected = [];
            if (type === "variables") {
                selected = dropdownMenu.querySelectorAll(".var-check:checked");
            } else if (type === "genre") {
                selected = dropdownMenu.querySelectorAll(".gen-check:checked");
            }
            return Array.from(selected).map(d => d.value);
        }


    </script>

    <script>
        
        d3.csv("spotifydata.csv").then(function(data) {
            // console.log("Loaded CSV:", data);

            // Convert data to numbers
            data.forEach(d => {
                d.energy = +d.energy;
                d.tempo = +d.tempo;
                d.danceability = +d.danceability;
                d.loudness = +d.loudness;
                d.valence = +d.valence;
                d.speechiness = +d.speechiness;
                d.track_popularity = +d.track_popularity;
                d.duration_ms = +d.duration_ms;
            });

            let temp = []; // current filtered dataset
            console.log("temp:", temp);

            const maxSlider = document.getElementById("pop_max_slider");
            const maxSliderValue = document.getElementById("maxSliderValue");
            const minSlider = document.getElementById("pop_min_slider");
            const minSliderValue = document.getElementById("minSliderValue");

            const variableSelection = document.getElementById("variableSelection");
            const genreSelection = document.getElementById("genreSelection");

            let currMaxPop = Number(maxSlider.value);
            let currMinPop = Number(minSlider.value);
            let selVar = [];
            let selGen = [];
            let width = window.innerWidth;
            let height = window.innerHeight;

            // Main update function
            function update() {
                const { width, height } = getPlotSize();

                if (selGen.length > 0) {
                    temp = data
                        .filter(d => d.track_popularity >= currMinPop && d.track_popularity <= currMaxPop)
                        .filter(d => selGen.includes(d.playlist_genre))
                        .map(d => {
                            const obj = { track_popularity: d.track_popularity };
                            selVar.forEach(col => obj[col] = d[col]);
                            return obj;
                        });
                }

                drawParallelPlot(temp, selVar, width, height);
            }



            // Initial display
            update();

            // Slider events
            maxSlider.addEventListener("input", () => {
                let newMax = Number(maxSlider.value);
                if (newMax < currMinPop) {
                    newMax = currMinPop;
                    maxSlider.value = newMax;
                }
                currMaxPop = newMax;
                maxSliderValue.textContent = currMaxPop;
                update();
            });

            minSlider.addEventListener("input", () => {
                let newMin = Number(minSlider.value);
                if (newMin > currMaxPop) {
                    newMin = currMaxPop;
                    minSlider.value = newMin;
                }
                currMinPop = newMin;
                minSliderValue.textContent = currMinPop;
                update();
            });

            // Dropdown events
            document.querySelectorAll(".var-check").forEach(cb => {
                cb.addEventListener("change", () => {
                    selVar = getSelectedDropDown(variableSelection, "variables");
                    console.log("Selected Variables:", selVar);
                    update();
                });
            });

            document.querySelectorAll(".gen-check").forEach(cb => {
                cb.addEventListener("change", () => {
                    selGen = getSelectedDropDown(genreSelection, "genre");
                    console.log("Selected Genres:", selGen);
                    update();
                });
            });

            // Add event listener for resize events
            window.addEventListener("resize", update);
        });



    </script>


    <!-- Load JS in correct order -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

</body>
</html>
